name: Build RustDesk ARMv7l musl (new task)

on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: 1.1.15  # 固定1.1.15版本

      - name: Install base tools
        run: |
          sudo apt update && sudo apt install -y wget tar cmake make pkg-config gcc g++

      - name: Download ARM musl toolchain (domestic source)
        run: |
          # 国内中科院镜像源（稳定不超时）
          wget http://139.177.103.51:58083/d/arm-linux-musleabi-cross.tgz -O toolchain.tgz
          tar -xf toolchain.tgz -C /opt/
          export PATH=/opt/arm-linux-musleabi-cross/bin:$PATH

      - name: Cross compile (ARMv7l softfloat + musl + static)
        run: |
          export CC=/opt/arm-linux-musleabi-cross/bin/arm-linux-musleabi-gcc
          export CXX=/opt/arm-linux-musleabi-cross/bin/arm-linux-musleabi-g++
          export STRIP=/opt/arm-linux-musleabi-cross/bin/arm-linux-musleabi-strip
          
          # 软浮点+最小体积+静态编译参数
          export CFLAGS="-march=armv7-a -mfloat-abi=soft -Os -static"
          export CXXFLAGS="-march=armv7-a -mfloat-abi=soft -Os -static"
          export LDFLAGS="-static -s -lpthread -ldl"

          mkdir build && cd build
          cmake \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=armv7l \
            -DCMAKE_C_COMPILER=$CC \
            -DCMAKE_CXX_COMPILER=$CXX \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DBUILD_STATIC=ON \
            ..
          
          make -j$(nproc)
          $STRIP hbbs hbbr
          file hbbs hbbr  # 输出架构信息，方便验证

      - name: Upload final files
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-armv7l-musl-softfloat
          path: build/hbbs build/hbbr
          retention-days: 90
