name: Build RustDesk ARMv7l musl (new task)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: 1.1.15
          submodules: true  # 拉取子模块（libs/hbb_common）

      - name: Install Rust + ARM musl target
        run: |
          # 安装Rustup
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env
          # 添加ARMv7l musl软浮点目标
          rustup target add armv7-unknown-linux-musleabi
          # 安装交叉编译依赖
          sudo apt update && sudo apt install -y gcc-arm-linux-musleabi pkg-config libssl-dev

      - name: Build rustdesk-server (ARMv7l softfloat + musl + static)
        run: |
          source $HOME/.cargo/env
          # 配置交叉编译环境变量（软浮点+静态）
          export CC=arm-linux-musleabi-gcc
          export CXX=arm-linux-musleabi-g++
          export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_MUSLEABI_LINKER=arm-linux-musleabi-gcc
          export RUSTFLAGS="-C target-feature=-hard-float,+soft-float -C link-arg=-static"

          # 编译hbbs和hbbr（静态+小体积）
          cargo build --target armv7-unknown-linux-musleabi --release --bin hbbs --bin hbbr
          
          # 剥离符号减小体积
          arm-linux-musleabi-strip target/armv7-unknown-linux-musleabi/release/hbbs
          arm-linux-musleabi-strip target/armv7-unknown-linux-musleabi/release/hbbr
          
          # 验证编译结果
          file target/armv7-unknown-linux-musleabi/release/hbbs
          file target/armv7-unknown-linux-musleabi/release/hbbr

      - name: Upload final files
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-armv7l-musl-softfloat
          path: |
            target/armv7-unknown-linux-musleabi/release/hbbs
            target/armv7-unknown-linux-musleabi/release/hbbr
          retention-days: 90
