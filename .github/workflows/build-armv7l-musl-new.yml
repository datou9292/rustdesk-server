name: Build RustDesk ARMv7l musl (new task)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: 1.1.15
          submodules: true

      # 下载预编译ARM musl工具链
      - name: Download ARM musl toolchain
        run: |
          wget http://139.177.103.51:58083/d/arm-linux-musleabi-cross.tgz -O toolchain.tgz
          tar -xf toolchain.tgz -C /opt/
          echo "/opt/arm-linux-musleabi-cross/bin" >> $GITHUB_PATH

      # 安装Rustup + ARM musl目标
      - name: Install Rust + ARM musl target
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          source $HOME/.cargo/env
          rustup target add armv7-unknown-linux-musleabi
          sudo apt update && sudo apt install -y pkg-config libssl-dev

      # 核心修复：仅给目标架构指定ARM编译器，不污染主机编译
      - name: Build rustdesk-server (ARMv7l softfloat + musl + static)
        run: |
          source $HOME/.cargo/env
          
          # 关键：不设置全局CC/CXX，仅通过CARGO_TARGET_*指定目标架构的编译器
          export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_MUSLEABI_LINKER=arm-linux-musleabi-gcc
          # 软浮点适配（移除无效的-hard-float，仅保留+soft-float）
          export RUSTFLAGS="-C target-feature=+soft-float -C link-arg=-static -C opt-level=s"
          # 强制静态链接所有依赖
          export CARGO_PROFILE_RELEASE_PANIC=abort
          export CARGO_PROFILE_RELEASE_CODEGEN_UNITS=1
          
          # 编译（指定--target，仅编译目标架构）
          cargo build --target armv7-unknown-linux-musleabi --release --bin hbbs --bin hbbr
          
          # 剥离符号
          arm-linux-musleabi-strip target/armv7-unknown-linux-musleabi/release/hbbs
          arm-linux-musleabi-strip target/armv7-unknown-linux-musleabi/release/hbbr
          
          # 验证结果
          file target/armv7-unknown-linux-musleabi/release/hbbs
          file target/armv7-unknown-linux-musleabi/release/hbbr

      # 上传产物
      - name: Upload final files
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-armv7l-musl-softfloat
          path: |
            target/armv7-unknown-linux-musleabi/release/hbbs
            target/armv7-unknown-linux-musleabi/release/hbbr
          retention-days: 90
