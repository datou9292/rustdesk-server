name: Build RustDesk ARMv7l musl (new task)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: 1.1.15

      - name: Install base tools
        run: |
          sudo apt update && sudo apt install -y wget tar cmake make pkg-config gcc g++

      - name: Download ARM musl toolchain (domestic source)
        run: |
          wget http://139.177.103.51:58083/d/arm-linux-musleabi-cross.tgz -O toolchain.tgz
          tar -xf toolchain.tgz -C /opt/
          export PATH=/opt/arm-linux-musleabi-cross/bin:$PATH

      - name: Cross compile (ARMv7l softfloat + musl + static)
        run: |
          # 核心修复：进入server子目录（CMakeLists.txt在这里）
          cd $GITHUB_WORKSPACE/server
          
          export CC=/opt/arm-linux-musleabi-cross/bin/arm-linux-musleabi-gcc
          export CXX=/opt/arm-linux-musleabi-cross/bin/arm-linux-musleabi-g++
          export STRIP=/opt/arm-linux-musleabi-cross/bin/arm-linux-musleabi-strip
          
          export CFLAGS="-march=armv7-a -mfloat-abi=soft -Os -static"
          export CXXFLAGS="-march=armv7-a -mfloat-abi=soft -Os -static"
          export LDFLAGS="-static -s -lpthread -ldl"

          # 在server目录下创建build
          mkdir -p build && cd build
          # cmake指向server根目录（.. 就是server目录，能找到CMakeLists.txt）
          cmake \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=armv7l \
            -DCMAKE_C_COMPILER=$CC \
            -DCMAKE_CXX_COMPILER=$CXX \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DBUILD_STATIC=ON \
            ..
          
          make -j$(nproc)
          $STRIP hbbs hbbr
          file hbbs hbbr

      - name: Upload final files
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-armv7l-musl-softfloat
          # 上传路径指向server/build
          path: $GITHUB_WORKSPACE/server/build/hbbs $GITHUB_WORKSPACE/server/build/hbbr
          retention-days: 90
