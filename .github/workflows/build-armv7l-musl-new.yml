name: Build RustDesk ARMv7l musl (new task)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          ref: 1.1.15
          submodules: true  # 拉取子模块

      # 步骤1：下载预编译的ARM musl软浮点工具链（替代apt安装）
      - name: Download ARM musl toolchain
        run: |
          # 用你之前的工具链下载地址（确保能访问）
          wget http://139.177.103.51:58083/d/arm-linux-musleabi-cross.tgz -O toolchain.tgz
          tar -xf toolchain.tgz -C /opt/
          # 把工具链加入全局环境变量
          echo "/opt/arm-linux-musleabi-cross/bin" >> $GITHUB_PATH

      # 步骤2：安装Rustup + ARM musl目标
      - name: Install Rust + ARM musl target
        run: |
          # 安装Rustup（静默安装）
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
          source $HOME/.cargo/env
          # 添加ARMv7l musl软浮点目标
          rustup target add armv7-unknown-linux-musleabi
          # 仅安装基础依赖（不再装gcc-arm-linux-musleabi）
          sudo apt update && sudo apt install -y pkg-config libssl-dev

      # 步骤3：交叉编译rustdesk-server（用预编译工具链）
      - name: Build rustdesk-server (ARMv7l softfloat + musl + static)
        run: |
          source $HOME/.cargo/env
          # 配置交叉编译环境（指向预编译工具链）
          export CC=arm-linux-musleabi-gcc
          export CXX=arm-linux-musleabi-g++
          export CARGO_TARGET_ARMV7_UNKNOWN_LINUX_MUSLEABI_LINKER=arm-linux-musleabi-gcc
          # 软浮点+静态编译+小体积
          export RUSTFLAGS="-C target-feature=-hard-float,+soft-float -C link-arg=-static -C opt-level=s"

          # 编译hbbs和hbbr（Release模式）
          cargo build --target armv7-unknown-linux-musleabi --release --bin hbbs --bin hbbr
          
          # 剥离符号减小体积
          arm-linux-musleabi-strip target/armv7-unknown-linux-musleabi/release/hbbs
          arm-linux-musleabi-strip target/armv7-unknown-linux-musleabi/release/hbbr
          
          # 验证编译结果
          file target/armv7-unknown-linux-musleabi/release/hbbs
          file target/armv7-unknown-linux-musleabi/release/hbbr

      # 步骤4：上传编译产物
      - name: Upload final files
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-armv7l-musl-softfloat
          path: |
            target/armv7-unknown-linux-musleabi/release/hbbs
            target/armv7-unknown-linux-musleabi/release/hbbr
          retention-days: 90
